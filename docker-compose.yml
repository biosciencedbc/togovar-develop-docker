version: '3.5'

services:
  nginx:
    image: nginx:1.17
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - app_tmp:/app/tmp
      - nginx_www:/var/www
      - ${PUBLIC_DIR}:/var/www/public
    ports:
      - ${NGINX_PORT:-80}:80
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    depends_on:
      - app
      - sparqlist
      - virtuoso
      - jbrowse
      - elasticsearch01
      - elasticsearch02
      - elasticsearch03
      - elasticsearch04
      - elasticsearch05

  app:
    build: docker/ruby
    image: togovar:#{VERSION}
    env_file: togovar.env
    volumes:
      - ./app:/app
      - ./stanza:/stanza
      - app_bundle:/usr/local/bundle
      - app_log:/app/log
      - app_node_modules:/app/node_modules
      - app_tmp:/app/tmp
      - nginx_www:/var/www
      - ${PUBLIC_DIR}:/var/www/public
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  sparqlist:
    image: dbcls/sparqlist:snapshot-1f7dbc9
    env_file: togovar.env
    volumes:
      - ./sparqlist:/app/repository
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  virtuoso:
    image: tenforce/virtuoso:virtuoso7.2.4
    env_file: togovar.env
    volumes:
      - ./docker/virtuoso/bin:/usr/local/bin
      - ${VIRTUOSO_VOLUMES_LOAD}:/load:ro
      - ${VIRTUOSO_VOLUMES_DATA}:/data
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  jbrowse:
    build: docker/jbrowse
    volumes:
      - ${JBROWSE_VOLUMES_DATA}:/usr/share/nginx/html/jbrowse/data

  elasticsearch01: &elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:7.7.0
    env_file: togovar.env
    environment:
      - node.name=node01
      - discovery.seed_hosts=elasticsearch02,elasticsearch03,elasticsearch04,elasticsearch05
    volumes:
      - ${ELASTICSEARCH_VOLUMES_01_DATA}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_VOLUMES_SNAPSHOT}:/usr/share/elasticsearch/snapshot
    ulimits:
      memlock:
        soft: -1
        hard: -1
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  elasticsearch02:
    <<: *elasticsearch
    env_file: togovar.env
    environment:
      - node.name=node02
      - discovery.seed_hosts=elasticsearch01,elasticsearch03,elasticsearch04,elasticsearch05
    volumes:
      - ${ELASTICSEARCH_VOLUMES_02_DATA}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_VOLUMES_SNAPSHOT}:/usr/share/elasticsearch/snapshot
    ports: []

  elasticsearch03:
    <<: *elasticsearch
    env_file: togovar.env
    environment:
      - node.name=node03
      - discovery.seed_hosts=elasticsearch01,elasticsearch02,elasticsearch04,elasticsearch05
    volumes:
      - ${ELASTICSEARCH_VOLUMES_03_DATA}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_VOLUMES_SNAPSHOT}:/usr/share/elasticsearch/snapshot
    ports: []

  elasticsearch04:
    <<: *elasticsearch
    env_file: togovar.env
    environment:
      - node.name=node04
      - discovery.seed_hosts=elasticsearch01,elasticsearch02,elasticsearch03,elasticsearch05
    volumes:
      - ${ELASTICSEARCH_VOLUMES_04_DATA}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_VOLUMES_SNAPSHOT}:/usr/share/elasticsearch/snapshot
    ports: []

  elasticsearch05:
    <<: *elasticsearch
    env_file: togovar.env
    environment:
      - node.name=node05
      - discovery.seed_hosts=elasticsearch01,elasticsearch02,elasticsearch03,elasticsearch04
    volumes:
      - ${ELASTICSEARCH_VOLUMES_05_DATA}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_VOLUMES_SNAPSHOT}:/usr/share/elasticsearch/snapshot
    ports: []

  kibana:
    image: docker.elastic.co/kibana/kibana:7.7.0
    env_file: togovar.env
    ports:
      - ${KIBANA_PORT:-15601}:5601
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

volumes:
  nginx_www:
    name: togovar_docker_nginx_www_${VERSION}
    driver: local
  app_bundle:
    name: togovar_docker_app_bundle_${VERSION}
    driver: local
  app_log:
    name: togovar_docker_app_log_${VERSION}
    driver: local
  app_node_modules:
    name: togovar_docker_app_node_modules_${VERSION}
    driver: local
  app_tmp:
    name: togovar_docker_app_tmp_${VERSION}
    driver: local
